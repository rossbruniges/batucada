{% extends "base.html" %}
{% load l10n_tags get_sub_projects %}

{% block title %}{{ project.name }}{% endblock %}

{% block links %}
<link rel="alternate" type="application/atom+xml" href="{% locale_url activity_project_feed project=project.slug %}" />
{% endblock %}

{% block breadcrumbs %}
<div class="container">
    <nav>
        <a href="{% locale_url projects_gallery %}">{{ _('Projects') }}</a>
        <span class="arrow">&rsaquo;</span>
        <a href="{% locale_url projects_show slug=project.slug %}">{{ project.name }}</a>
    </nav>

    {% if user.get_profile == project.created_by %}
        <div id="project-actions">
            <a class="button" href="{% locale_url projects_edit slug=project.slug %}">{{ _('Edit Project') }}</a>
            <a class="button" href="{% locale_url projects_contact_followers slug=project.slug %}">{{ _('Message Followers') }}</a>
            {% if project.slug == 'mojo' %}
                <a class="button" href="{% locale_url challenges_create project_id=project.pk %}">{{ _('Create Challenge') }}</a>
            {% endif %}
        </div>
    {% endif %}
</div> <!-- /.container -->
{% endblock %}

{% block bodyid %}project_landing{% endblock %}

{% block body %}
<div id="sidebar">
    <section id="project" class="panel">
        <hgroup>
        <h1 id="project-name">{{ project.name }}</h1>
        {% if project.parent_project_id %}
            <h2>A sub-project of <a href="{% locale_url projects_show slug=parent.slug %}">{{ parent.name }}</a></h2> 
        {% endif %}
        <hgroup>
        {% if user.is_authenticated and user.get_profile != project.created_by %}
            <div id="project-follow">
            {% if following %}
                <form method="post" action="{% locale_url relationships_unfollow object_type='project' slug=project.slug %}">
                {% csrf_token %}
                <button>{{ _('Unfollow') }}</button>
                </form>
            {% else %}
                <form method="post" action="{% locale_url relationships_follow object_type='project' slug=project.slug %}">
                {% csrf_token %}
                <button>{{ _('Follow Project') }}</button>
                </form>
            {% endif %}
            </div> <!-- /#project-follow -->
        {% endif %}

        <dl id="project-stats">
            <dt>Followers</dt>
            <dd>{{ followers_count }}</dd>
            <dt>Updates</dt>
            <dd>{{ update_count }}</dd>
        </dl> <!-- /#project-stats -->

        <div id="project-summary">
            {{ project.long_description }}
        </div>

        {% if files %}
            <ul class="project files">
            {% for file in files %}
                <li id="file_{{ file.id}}">
                    <a href="{{ MEDIA_URL }}{{ file.project_file }}">
                    <img alt="" src="{{ MEDIA_URL }}{{ file.thumbnail_or_default }}" class="project media" />
                    </a>
                </li>
            {% endfor %}
            </ul>
        {% endif %}

        {% if project.detailed_description %}
            <a id="project-description-link" href="{% locale_url projects_show_detailed slug=project.slug %}">View Full Project Description</a>
        {% endif %}
        {% if user.is_authenticated and user.get_profile != project.created_by %}
            <p class="supplemental_actions">
            <a class="report abuse action" href="{% locale_url drumbeat_abuse  obj=project.id type="project" %}">{{_('Report Abuse')}}</a>
            </p>  
        {% endif %}      
    </section>
    
    {% if links %}
        <nav id="project-links" class="panel">      
            <ul>
            {% for link in links %}
            <li><a href="{{ link.url }}">{{ link.name }}</a></li>
            {% endfor %}
            </ul>       
        </nav>
    {% endif %} 
 {% get_sub_projects project.id project.allow_sub_projects project.id  %}
    <section id="project-lead" class="panel">
        <a href="{{ project.created_by.get_absolute_url }}">
            <img alt="" class="member-picture" src="{{ MEDIA_URL }}{{ project.created_by.image_or_default }}" height="54" width="54">
        </a>
        <div class="member-details">
            <h3 class="member-name">
                <a href="{{ project.created_by.get_absolute_url }}">{{ project.created_by.name }}</a>
            </h3>

            {% if user.is_authenticated %}
            <div class="member-actions">
                {% if project.created_by != user.get_profile %}
                    {% if project.created_by in user.get_profile.following %}
                        <form action="{% locale_url relationships_unfollow object_type='user' slug=project.created_by.username %}" method="post">
                        {% csrf_token %}
                        <button id="unfollow-user" >Unfollow</button>
                        </form>
                    {% else %}
                        <form action="{% locale_url relationships_follow object_type='user' slug=project.created_by.username %}" method="post">
                        {% csrf_token %}
                        <button id="follow-user">Follow</button>
                        </form>
                    {% endif %}
                    <a class="button" href="{% locale_url drumbeatmail_compose_to username=project.created_by.username %}">{{ _('Private Message')}}</a>
                {% endif %}
            </div>     
            {% endif %}
        </div> <!-- /.member-details -->
        <div class="member-bio">
            {{ project.created_by.bio }}
        </div>
    </section> <!-- /#project-lead --> 
</div> <!-- /#sidebar -->

<div id="main">
    {% if challenges %}
        {% if project.slug == "mojo" %}
        <div class="voting-info">
            <h2>Voting has ended</h2>
            <p>Crowd evaluation is closed, and the review board has rated the submissions. Stay tuned as we announce challenge winners.</p>
        </div>
        {% endif %}
        <div id="challenge_header" class="challenges">
            <h2>{{ _('Challenges') }}</h2>
            <ul>
            {% for challenge in challenges %}
                <li>
                <a href="{% locale_url challenges_show slug=challenge.slug %}">
                {% if challenge.image %}
                <img src="{{ challenge.image.url }}" alt="{{ challenge }} image" />
                {% else %}
                <img src="/media/images/project-missing.png" alt="{{ challenge }} image"/>
                {% endif %}
                </a>
                <a href="{% locale_url challenges_show slug=challenge.slug %}">{{challenge.title}}</a>
            </li>
            {% endfor %}
            </ul>
        </div> <!-- /.challenges -->
    {% endif %}

    {% if project.allow_challenges %}
        <p><a class="button" href="{% locale_url challenges_create project_id=project.pk %}">{{ _('Add your own project challenge') }}</a></p>
    {% endif %}

    {% if user.is_authenticated %}
        <div id="create-post">
            <div class="post-container">
                <form action="{% locale_url statuses_create_project project_id=project.id %}" method="post" id="post-project-status-update">
	            {% csrf_token %}
	            <input type="text" value="{{ _('Post a message to this project') }}" title="{{_('Post a message to this project')}}">
	            <textarea name="status" title="{{_('Post a message to this project')}}"></textarea>
	            <div class="status-and-actions">
	                <div class="post-char-count">750</div> 
	                <ul class="post-tags">
	                    <li><span>{{ project.name }}</span></li>
	                </ul>
                    <button class="button update submit" id="post-project-update">Post Update</button>
	            </div> <!-- /.status-and-actions -->
	            </form>
            </div> <!-- /.post-container -->
        </div> <!-- /.#create-post -->
    {% endif %}

    <ul id="posts">
        {% for activity in activities %}
	        {% include "activity/_activity_resource.html" %}
        {% endfor %}
    </ul>
</div> <!-- /#main -->
{% endblock %}
